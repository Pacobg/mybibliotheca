# Perplexity AI Enrichment Service - Implementation Summary

## –û–±—â –ø—Ä–µ–≥–ª–µ–¥

–¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å–≤–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ç–∞ –Ω–∞ Perplexity AI –æ–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏ –∑–∞ –∫–Ω–∏–≥–∏ –≤ MyBibliotheca —Å–∏—Å—Ç–µ–º–∞—Ç–∞. –£—Å–ª—É–≥–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—ä—Ä—Å–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –∫–Ω–∏–≥–∏, –Ω–∞–º–∏—Ä–∞ –∫–æ—Ä–∏—Ü–∏, –∏–∑–≤–ª–∏—á–∞ –æ–ø–∏—Å–∞–Ω–∏—è, ISBN –Ω–æ–º–µ—Ä–∞, –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞ –∏ –¥—Ä—É–≥–∞ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.

## –î–∞—Ç–∞ –Ω–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è

24 –¥–µ–∫–µ–º–≤—Ä–∏ 2025

## –û—Å–Ω–æ–≤–Ω–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. PerplexityEnricher (`app/services/metadata_providers/perplexity.py`)

–û—Å–Ω–æ–≤–Ω–∏—è—Ç –∫–ª–∞—Å –∑–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Perplexity AI API.

**–û—Å–Ω–æ–≤–Ω–∏ –º–µ—Ç–æ–¥–∏:**
- `async def fetch_metadata()` - –ò–∑–≤–ª–∏—á–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏ –∑–∞ –∫–Ω–∏–≥–∞
- `async def find_cover_image()` - –¢—ä—Ä—Å–∏ –∫–æ—Ä–∏—Ü–∞ –∑–∞ –∫–Ω–∏–≥–∞
- `_build_metadata_query()` - –ö–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞ –∑–∞—è–≤–∫–∞ –∫—ä–º AI —Å–ø–æ—Ä–µ–¥ –µ–∑–∏–∫–∞ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- `_parse_response()` - –ü–∞—Ä—Å–≤–∞ JSON –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç AI

**–ö–ª—é—á–æ–≤–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∫–Ω–∏–≥–∞—Ç–∞ (–±—ä–ª–≥–∞—Ä—Å–∫–∏/–∞–Ω–≥–ª–∏–π—Å–∫–∏) —Å–ø–æ—Ä–µ–¥ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- –†–∞–∑–ª–∏—á–Ω–∏ –∑–∞—è–≤–∫–∏ –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –∫–Ω–∏–≥–∏
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∞–≤—Ç–æ—Ä–∏ (–µ–¥–∏–Ω –æ—Å–Ω–æ–≤–µ–Ω –∞–≤—Ç–æ—Ä, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–µ –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–Ω–∏–≥–∏)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ—Ç–æ –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏—Ç–µ

### 2. EnrichmentService (`app/services/enrichment_service.py`)

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞ –ø—Ä–æ—Ü–µ—Å–∞ –Ω–∞ –æ–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ.

**–û—Å–Ω–æ–≤–Ω–∏ –º–µ—Ç–æ–¥–∏:**
- `async def enrich_single_book()` - –û–±–æ–≥–∞—Ç—è–≤–∞ –µ–¥–Ω–∞ –∫–Ω–∏–≥–∞
- `async def enrich_batch()` - –û–±–æ–≥–∞—Ç—è–≤–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–Ω–∏–≥–∏
- `merge_metadata_into_book()` - –°–ª–∏–≤–∞ AI –º–µ—Ç–∞–¥–∞–Ω–Ω–∏ —Å —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –¥–∞–Ω–Ω–∏
- `_has_sufficient_data()` - –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –∫–Ω–∏–≥–∞—Ç–∞ –∏–º–∞ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –¥–∞–Ω–Ω–∏

**–ö–ª—é—á–æ–≤–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ —Å–ø—Ä—è–º–æ –µ–∑–∏–∫–∞ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- –û—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è, –∫–æ–∏—Ç–æ –Ω–µ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞—Ç –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- –ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ `require_cover` —Ñ–ª–∞–≥ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ —Å–∞–º–æ –Ω–∞ –∫–æ—Ä–∏—Ü–∏

### 3. EnrichmentCommand (`scripts/enrich_books.py`)

–ö–æ–º–∞–Ω–¥–µ–Ω —Ä–µ–¥ —Å–∫—Ä–∏–ø—Ç –∑–∞ batch –æ–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ.

**–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `_get_books_to_enrich()` - –ù–∞–º–∏—Ä–∞ –∫–Ω–∏–≥–∏ –∑–∞ –æ–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ
- `_save_enriched_books()` - –ó–∞–ø–∞–∑–≤–∞ –æ–±–æ–≥–∞—Ç–µ–Ω–∏—Ç–µ –∫–Ω–∏–≥–∏ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
- `_get_book_by_title()` - –ù–∞–º–∏—Ä–∞ –∫–Ω–∏–≥–∞ –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ
- `_get_book_by_id()` - –ù–∞–º–∏—Ä–∞ –∫–Ω–∏–≥–∞ –ø–æ ID

**–ö–æ–º–∞–Ω–¥–µ–Ω —Ä–µ–¥ –æ–ø—Ü–∏–∏:**
- `--limit N` - –û–≥—Ä–∞–Ω–∏—á–∞–≤–∞ –±—Ä–æ—è –∫–Ω–∏–≥–∏
- `--force` - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ –æ–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ –¥–æ—Ä–∏ –∞–∫–æ –∏–º–∞ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –¥–∞–Ω–Ω–∏
- `--dry-run` - –ü–æ–∫–∞–∑–≤–∞ –∫–∞–∫–≤–æ —â–µ —Å–µ –æ–±–æ–≥–∞—Ç–∏ –±–µ–∑ –¥–∞ –∑–∞–ø–∏—Å–≤–∞
- `--book-id ID` - –û–±–æ–≥–∞—Ç—è–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –∫–Ω–∏–≥–∞ –ø–æ ID
- `--book-title "TITLE"` - –û–±–æ–≥–∞—Ç—è–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –∫–Ω–∏–≥–∞ –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ
- `--no-cover-only` - –û–±–æ–≥–∞—Ç—è–≤–∞ —Å–∞–º–æ –∫–Ω–∏–≥–∏ –±–µ–∑ –∫–æ—Ä–∏—Ü–∏
- `--quality-min SCORE` - –ú–∏–Ω–∏–º–∞–ª–µ–Ω quality score (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ 0.7)

## –ö–ª—é—á–æ–≤–∏ –ø–æ–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è

### 1. –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∫–Ω–∏–≥–∞—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ –≤—Å–∏—á–∫–∏ –∑–∞—è–≤–∫–∏ –∫—ä–º Perplexity –±—è—Ö–∞ –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏, –¥–æ—Ä–∏ –∑–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –∫–Ω–∏–≥–∏.

**–†–µ—à–µ–Ω–∏–µ:** 
- –î–æ–±–∞–≤–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ –≤ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- –ë—ä–ª–≥–∞—Ä—Å–∫–∏ –∑–∞–≥–ª–∞–≤–∏—è ‚Üí –±—ä–ª–≥–∞—Ä—Å–∫–∞ –∑–∞—è–≤–∫–∞ ‚Üí –±—ä–ª–≥–∞—Ä—Å–∫–∏ metadata
- –ê–Ω–≥–ª–∏–π—Å–∫–∏ –∑–∞–≥–ª–∞–≤–∏—è ‚Üí –∞–Ω–≥–ª–∏–π—Å–∫–∞ –∑–∞—è–≤–∫–∞ ‚Üí –∞–Ω–≥–ª–∏–π—Å–∫–∏ metadata

**–ö–æ–¥:**
```python
has_cyrillic = any('\u0400' <= char <= '\u04FF' for char in title)
if has_cyrillic:
    # Bulgarian query
else:
    # English query
```

### 2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∞–≤—Ç–æ—Ä–∏

**–ü—Ä–æ–±–ª–µ–º:** AI –≤—Ä—ä—â–∞—à–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∞–≤—Ç–æ—Ä–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä–∏ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª–Ω–∏—è –µ–∑–∏–∫.

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–Ω–∏–≥–∏: –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–µ –Ω–∞ –∫–∏—Ä–∏–ª–∏—á–Ω–æ –∏–º–µ
- –ó–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –∫–Ω–∏–≥–∏: –æ—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –∫–∏—Ä–∏–ª–∏—á–Ω–∏ –∏–º–µ–Ω–∞
- –í–∑–µ–º–∞–Ω–µ —Å–∞–º–æ –Ω–∞ –ø—ä—Ä–≤–∏—è –æ—Å–Ω–æ–≤–µ–Ω –∞–≤—Ç–æ—Ä

**–ö–æ–¥:**
```python
if has_cyrillic_title:
    cyrillic_authors = [a for a in authors_list if any('\u0400' <= char <= '\u04FF' for char in a)]
    if cyrillic_authors:
        ai_author = cyrillic_authors[0]
else:
    english_authors = [a for a in authors_list if not any('\u0400' <= char <= '\u04FF' for char in a)]
    if english_authors:
        ai_author = english_authors[0]
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** AI –≤—Ä—ä—â–∞—à–µ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª–Ω–∏—è –µ–∑–∏–∫ (–±—ä–ª–≥–∞—Ä—Å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∞ –∫–Ω–∏–≥–∞).

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞ –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
- –û—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è, –∫–æ–∏—Ç–æ –Ω–µ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞—Ç
- –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ —Å–∞–º–æ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è, –∫–æ–∏—Ç–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞—Ç –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ

**–ö–æ–¥:**
```python
has_cyrillic_title = any('\u0400' <= char <= '\u04FF' for char in title)
ai_has_cyrillic = any('\u0400' <= char <= '\u04FF' for char in ai_desc)
ai_matches_title = (has_cyrillic_title and ai_has_cyrillic) or (not has_cyrillic_title and not ai_has_cyrillic)

if ai_matches_title:
    merged['description'] = ai_desc
else:
    logger.warning(f"üö´ Rejecting description that doesn't match title language")
```

### 4. –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ü–∏—Ç–∞—Ç–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏—è—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** AI –≤—Ä—ä—â–∞—à–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å —Ü–∏—Ç–∞—Ç–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏ –∫–∞—Ç–æ `[3][5][7][9]`.

**–†–µ—à–µ–Ω–∏–µ:**
- Regex –∑–∞ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ –Ω–∞ —Ü–∏—Ç–∞—Ç–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏: `re.sub(r'\[\d+\]', '', description)`
- –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏

**–ö–æ–¥:**
```python
description = re.sub(r'\[\d+\]', '', description)
description = re.sub(r'\s+', ' ', description).strip()
```

### 5. –ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∫–æ—Ä–∏—Ü–∞—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** –ö–æ—Ä–∏—Ü–∞—Ç–∞ –Ω–µ —Å–µ –∑–∞–ø–∏—Å–≤–∞—à–µ –ø—Ä–∞–≤–∏–ª–Ω–æ –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏ - `update_book` –∏–∑–ø–æ–ª–∑–≤–∞—à–µ —Å—Ç–∞—Ä–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –≤–º–µ—Å—Ç–æ –Ω–æ–≤–∞—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–ø—Ä–∞–≤–∫–∞ –≤ `KuzuBookService.update_book()` –º–µ—Ç–æ–¥–∞
- –í–∏–Ω–∞–≥–∏ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –Ω–æ–≤–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –æ—Ç `updates` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–∞—Ç–∞ –æ—Ç `book` –æ–±–µ–∫—Ç–∞

**–ö–æ–¥:**
```python
elif field == 'cover_url':
    current_cover = getattr(book, 'cover_url', None)
    if (value is None or (isinstance(value, str) and not value.strip())) and current_cover:
        continue
    # Always use the new value from updates
    book_dict[field] = value
```

### 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ URL –Ω–∞ –∫–æ—Ä–∏—Ü–∞—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** AI –≤—Ä—ä—â–∞—à–µ –ª–æ–∫–∞–ª–Ω–∏ –ø—ä—Ç–∏—â–∞ –≤–º–µ—Å—Ç–æ –≤–∞–ª–∏–¥–Ω–∏ HTTP/HTTPS URL-–∏.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ URL –∑–∞–ø–æ—á–≤–∞ —Å `http://` –∏–ª–∏ `https://`
- –û—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–Ω–∏ –ø—ä—Ç–∏—â–∞ –∫–∞—Ç–æ `/covers/...`
- –ó–∞–º—è–Ω–∞ –Ω–∞ –ª–æ–∫–∞–ª–Ω–∏ –ø—ä—Ç–∏—â–∞ —Å –≤–∞–ª–∏–¥–Ω–∏ URL-–∏ –∫–æ–≥–∞—Ç–æ –µ –Ω–∞–ª–∏—á–µ–Ω –Ω–æ–≤ URL

**–ö–æ–¥:**
```python
is_valid_url = new_cover_url.startswith('http://') or new_cover_url.startswith('https://')
current_is_local = current_cover_url.startswith('/covers/') if current_cover_url else True

if (not current_cover_url or (current_is_local and is_valid_url) or self.args.force):
    if is_valid_url:
        updates['cover_url'] = new_cover_url
```

### 7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ –µ–∑–∏–∫–∞ –Ω–∞ –∫–Ω–∏–≥–∞—Ç–∞

**–ü—Ä–æ–±–ª–µ–º:** –ö–Ω–∏–≥–∏—Ç–µ —Å –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∑–∞–≥–ª–∞–≤–∏—è –æ—Å—Ç–∞–≤–∞—Ö–∞ —Å `language='en'`.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ –≤ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ –∏ –∞–≤—Ç–æ—Ä–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ `language='bg'` –∑–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–Ω–∏–≥–∏

**–ö–æ–¥:**
```python
has_cyrillic_title = any('\u0400' <= char <= '\u04FF' for char in title)
has_cyrillic_author = any('\u0400' <= char <= '\u04FF' for char in ai_author)

if has_cyrillic_title and has_cyrillic_author:
    if current_language != 'bg':
        updates['language'] = 'bg'
```

### 8. –ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ `--no-cover-only` —Ñ–ª–∞–≥

**–ü—Ä–æ–±–ª–µ–º:** –ù—è–º–∞—à–µ –Ω–∞—á–∏–Ω –¥–∞ –æ–±–æ–≥–∞—Ç—è–≤–∞–º–µ —Å–∞–º–æ –∫–Ω–∏–≥–∏ –±–µ–∑ –∫–æ—Ä–∏—Ü–∏.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–µ–Ω `--no-cover-only` –∞—Ä–≥—É–º–µ–Ω—Ç
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞ –∑–∞ –Ω–∞–º–∏—Ä–∞–Ω–µ –Ω–∞ –∫–Ω–∏–≥–∏ –±–µ–∑ –∫–æ—Ä–∏—Ü–∏
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–Ω `_has_sufficient_data()` –¥–∞ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –∑–∞ –∫–æ—Ä–∏—Ü–∞ –∫–æ–≥–∞—Ç–æ –µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

**–ö–æ–¥:**
```python
if hasattr(self.args, 'no_cover_only') and self.args.no_cover_only:
    query = """
    MATCH (b:Book)
    WHERE (b.cover_url IS NULL OR b.cover_url = '' OR NOT (b.cover_url STARTS WITH 'http://' OR b.cover_url STARTS WITH 'https://'))
    ...
    """
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment Variables

```bash
PERPLEXITY_API_KEY=your_api_key_here
PERPLEXITY_MODEL=sonar-pro  # –∏–ª–∏ sonar-deep-research, llama-3.1-70b-instruct
PERPLEXITY_MIN_QUALITY=0.7
PERPLEXITY_RATE_LIMIT=1.0  # —Å–µ–∫—É–Ω–¥–∏ –º–µ–∂–¥—É –∑–∞—è–≤–∫–∏
PERPLEXITY_DOWNLOAD_COVERS=true
```

### –ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ –º–æ–¥–µ–ª–∏

- `sonar-pro` (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ) - –ë–∞–ª–∞–Ω—Å–∏—Ä–∞–Ω –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç –∏ –∫–∞—á–µ—Å—Ç–≤–æ
- `sonar-deep-research` - –ü–æ-–∑–∞–¥—ä–ª–±–æ—á–µ–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ
- `llama-3.1-70b-instruct` - –ê–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

## –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ

### –û—Å–Ω–æ–≤–Ω–∞ —É–ø–æ—Ç—Ä–µ–±–∞

```bash
# –û–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –∫–Ω–∏–≥–∏ –±–µ–∑ –∫–æ—Ä–∏—Ü–∏
python scripts/enrich_books.py --no-cover-only -y

# –û–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –∫–Ω–∏–≥–∞ –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ
python scripts/enrich_books.py --book-title "13 –∑–∞ –∫—ä—Å–º–µ—Ç" --force -y

# –û–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –∫–Ω–∏–≥–∞ –ø–æ ID
python scripts/enrich_books.py --book-id "bb543e76-8fb3-4fc0-a9cc-2a7fdccb7d16" --force -y

# Dry run - –ø–æ–∫–∞–∑–≤–∞ –∫–∞–∫–≤–æ —â–µ —Å–µ –æ–±–æ–≥–∞—Ç–∏ –±–µ–∑ –¥–∞ –∑–∞–ø–∏—Å–≤–∞
python scripts/enrich_books.py --limit 10 --dry-run

# –û–±–æ–≥–∞—Ç—è–≤–∞–Ω–µ —Å –ø–æ-–Ω–∏—Å—ä–∫ quality threshold
python scripts/enrich_books.py --limit 5 --quality-min 0.3 -y
```

### –ü—Ä–∏–º–µ—Ä–∏

**–ë—ä–ª–≥–∞—Ä—Å–∫–∞ –∫–Ω–∏–≥–∞:**
```bash
python scripts/enrich_books.py --book-title "13 –∑–∞ –∫—ä—Å–º–µ—Ç" --force -y
```
- –¢—ä—Ä—Å–∏ –±—ä–ª–≥–∞—Ä—Å–∫–æ –∏–∑–¥–∞–Ω–∏–µ
- –ò–∑–ø–æ–ª–∑–≤–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∞–≤—Ç–æ—Ä ("–ê–≥–∞—Ç–∞ –ö—Ä–∏—Å—Ç–∏")
- –ò–∑–ø–æ–ª–∑–≤–∞ –±—ä–ª–≥–∞—Ä—Å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ
- –¢—ä—Ä—Å–∏ –∫–æ—Ä–∏—Ü–∞ –æ—Ç –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Å–∞–π—Ç–æ–≤–µ (ciela.com, chitanka.info, etc.)

**–ê–Ω–≥–ª–∏–π—Å–∫–∞ –∫–Ω–∏–≥–∞:**
```bash
python scripts/enrich_books.py --book-title "The Secret History" --force -y
```
- –¢—ä—Ä—Å–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ –∏–∑–¥–∞–Ω–∏–µ
- –ò–∑–ø–æ–ª–∑–≤–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏ –∞–≤—Ç–æ—Ä ("Donna Tartt")
- –ò–∑–ø–æ–ª–∑–≤–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ
- –¢—ä—Ä—Å–∏ –∫–æ—Ä–∏—Ü–∞ –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏ —Å–∞–π—Ç–æ–≤–µ (Goodreads, Amazon, etc.)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ

### AI Response Format

```json
{
    "title": "–ó–∞–≥–ª–∞–≤–∏–µ",
    "subtitle": "–ü–æ–¥–∑–∞–≥–ª–∞–≤–∏–µ",
    "author": "–ê–≤—Ç–æ—Ä",
    "translator": "–ü—Ä–µ–≤–æ–¥–∞—á",
    "publisher": "–ò–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ",
    "year": "2024",
    "isbn": "978-954-xxx-xxx-x",
    "pages": 384,
    "genres": ["–ñ–∞–Ω—Ä1", "–ñ–∞–Ω—Ä2"],
    "description": "–û–ø–∏—Å–∞–Ω–∏–µ...",
    "cover_url": "https://url-to-cover.jpg",
    "confidence": 0.95,
    "sources": ["url1", "url2"]
}
```

### Quality Score

Quality score —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞ –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞:
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ –∏ –∞–≤—Ç–æ—Ä (–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏)
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ –∫–æ—Ä–∏—Ü–∞
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ ISBN
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∏
- –ù–∞–ª–∏—á–∏–µ –Ω–∞ –∂–∞–Ω—Ä–æ–≤–µ

## –ò–∑–≤–µ—Å—Ç–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Rate Limiting:** Perplexity API –∏–º–∞ rate limits. –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –∏–∑—á–∞–∫–≤–∞–º–µ 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –∑–∞—è–≤–∫–∏.

2. **API Costs:** –ò–∑–ø–æ–ª–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ Perplexity API –º–æ–∂–µ –¥–∞ –∏–º–∞ —Ä–∞–∑—Ö–æ–¥–∏. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ü–µ–Ω–∏—Ç–µ –Ω–∞ Perplexity.

3. **Quality Score:** –ù—è–∫–æ–∏ –∫–Ω–∏–≥–∏ –º–æ–∂–µ –¥–∞ –ø–æ–ª—É—á–∞—Ç –Ω–∏—Å—ä–∫ quality score –ø–æ—Ä–∞–¥–∏ –ª–∏–ø—Å–∞ –Ω–∞ –¥–∞–Ω–Ω–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

4. **Cover URLs:** –ù—è–∫–æ–∏ URL-–∏ –Ω–∞ –∫–æ—Ä–∏—Ü–∏ –º–æ–∂–µ –¥–∞ –Ω–µ —Å–∞ –¥–æ—Å—Ç—ä–ø–Ω–∏ –∏–ª–∏ –¥–∞ –∏–∑—Ç–µ–≥–ª—è—Ç –±–∞–≤–Ω–æ.

## –ë—ä–¥–µ—â–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è

1. **–ö–µ—à–∏—Ä–∞–Ω–µ:** –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–µ—à –∑–∞ –≤–µ—á–µ –æ–±–æ–≥–∞—Ç–µ–Ω–∏ –∫–Ω–∏–≥–∏
2. **Retry Logic:** –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ retry –ª–æ–≥–∏–∫–∞ –∑–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∏ API –∑–∞—è–≤–∫–∏
3. **Batch Processing:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ batch –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞
4. **Progress Tracking:** –ü–æ-–¥–æ–±—Ä–æ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –Ω–∞ –Ω–∞–ø—Ä–µ–¥—ä–∫–∞
5. **Error Reporting:** –ü–æ-–ø–æ–¥—Ä–æ–±–Ω–∏ error reports

## –§–∞–π–ª–æ–≤–µ

- `app/services/metadata_providers/perplexity.py` - PerplexityEnricher –∫–ª–∞—Å
- `app/services/enrichment_service.py` - EnrichmentService –∫–ª–∞—Å
- `scripts/enrich_books.py` - –ö–æ–º–∞–Ω–¥–µ–Ω —Ä–µ–¥ —Å–∫—Ä–∏–ø—Ç
- `docs/PERPLEXITY_ENRICHMENT.md` - –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –ê–≤—Ç–æ—Ä–∏

–ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–æ –Ω–∞ 24 –¥–µ–∫–µ–º–≤—Ä–∏ 2025 –≥.

## –õ–∏—Ü–µ–Ω–∑

–ß–∞—Å—Ç –æ—Ç MyBibliotheca –ø—Ä–æ–µ–∫—Ç–∞.

