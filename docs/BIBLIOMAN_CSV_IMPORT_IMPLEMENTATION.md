# Biblioman CSV Import - Детайлна документация

## Общ преглед

Създадена е специализирана функционалност за импорт на книги от CSV файлове с автоматично обогатяване с данни от Biblioman DB. Тази функционалност е отделена от основния импорт и е оптимизирана специално за български книги.

## Проблеми, които решаваме

1. **Ограничение от 200 книги** - Увеличен лимит до 600 книги на импорт
2. **Липсваща информация** - Автоматично обогатяване с данни от Biblioman DB
3. **Липсващи корици и описания** - Приоритизиране на Biblioman данните за попълване на липсваща информация
4. **Двойни имена на автори** - Приоритизиране на българските имена пред английските
5. **Невалидни категории** - Филтриране на авторски имена и generic термини от категориите

## Файлове, които са създадени/променени

### 1. Нов файл: `app/templates/import_biblioman_csv.html`

**Описание:** HTML template за специализираната страница за Biblioman CSV импорт.

**Основни елементи:**
- Форма за качване на CSV файл
- Инструкции на български език
- Обяснение на особеностите на импорта:
  - Приоритет на Biblioman данните
  - Автоматично обогатяване
  - Поддръжка на кирилица
  - Лимит от 1000 книги (конфигурируем)

### 2. Променен файл: `app/routes/import_routes.py`

#### 2.1. Нова константа

```python
MAX_BIBLIOMAN_IMPORT_ROWS = int(os.getenv('MAX_BIBLIOMAN_IMPORT_ROWS', '1000'))
```

- Конфигурируем лимит чрез environment variable
- По подразбиране: 1000 книги
- Позволява лесно променяне без код промени

#### 2.2. Нов route: `/import-biblioman-csv`

**Методи:** GET, POST

**Функционалност:**
- Валидация на CSV файла (формат, размер, не празен)
- Проверка на лимита от книги
- Автоматично разпознаване и mapping на CSV колони:
  - Поддръжка на английски и български имена на полетата
  - Специфични мапинги за HandyLib формат:
    - `Summary` → `description`
    - `Image Url` → `cover_url`
    - `Published Date` → `published_date`
    - `Pages` → `page_count`
    - `Series` → `series`
    - `Volume` → `series_volume`
    - `Genres` → `categories`
    - `Language` → `language`
- Създаване на import job
- Асинхронно стартиране на обработката

#### 2.3. Нова функция: `process_biblioman_csv_import(import_config)`

**Тип:** Async функция

**Функционалност:**
- Четене и обработка на CSV файла ред по ред
- За всеки ред:
  1. Изграждане на `SimplifiedBook` обект от CSV данните
  2. Опит за обогатяване с Biblioman данни:
     - Приоритет: ISBN → Title+Author → Title only
     - Използва `BibliomanProvider.search_metadata()`
  3. Сливане на Biblioman данни в книгата чрез `merge_biblioman_data_into_book()`
  4. Добавяне на книгата към библиотеката на потребителя
  5. Обработка на съществуващи книги (`BookAlreadyExistsError`):
     - Опит за обогатяване на съществуващата книга
     - Добавяне към библиотеката на потребителя (ако не е там)
     - Третиране като "success" или "skipped" вместо "error"
  6. Актуализация на прогрес и статистики

**Статистики:**
- `processed_count` - общ брой обработени книги
- `success_count` - успешно добавени книги
- `error_count` - грешки при импорт
- `skipped_count` - пропуснати книги (вече съществуващи)
- `enriched_count` - книги, обогатени с Biblioman данни

#### 2.4. Нова функция: `merge_biblioman_data_into_book(simplified_book, biblioman_data)`

**Цел:** Сливане на Biblioman метаданни в `SimplifiedBook` обект с приоритет на Biblioman данните.

**Стратегия за всяко поле:**

1. **Title (Заглавие):**
   - Винаги използва Biblioman заглавието (по-точно за български книги)

2. **Authors (Автори):**
   - Приоритизира българските (кирилски) имена пред английските
   - Ако има българско име → основен автор
   - Ако няма българско → английското като основен
   - Другите имена → допълнителни автори
   - Поддръжка на разделители: запетая и точка и запетая

3. **Description (Описание):**
   - Използва Biblioman описанието ако:
     - CSV няма описание, ИЛИ
     - Biblioman описанието е по-дълго (с поне 50 символа)

4. **Cover (Корица):**
   - Винаги приоритизира Biblioman корицата
   - Използва `chitanka_cover_url` ако е налично, иначе `cover_url`
   - Запазва CSV корицата само ако Biblioman няма корица

5. **ISBN:**
   - Използва Biblioman ISBN-ите (по-точни)

6. **Publisher (Издателство):**
   - Използва Biblioman издателството ако:
     - CSV няма издателство, ИЛИ
     - Biblioman издателството съдържа кирилица

7. **Published Date (Дата на публикуване):**
   - Използва Biblioman датата ако CSV няма дата

8. **Page Count (Брой страници):**
   - Използва Biblioman брой страници ако CSV няма

9. **Categories (Категории):**
   - Слива CSV и Biblioman категориите
   - Премахва дубликати
   - Филтрира невалидни категории (авторски имена, generic термини)

10. **Series (Серия):**
    - Използва Biblioman серията ако CSV няма

11. **Custom Metadata:**
    - Добавя `biblioman_id` и `chitanka_id` в `global_custom_metadata`
    - Добавя `chitanka_url` ако е налично
    - Маркира източника на корицата като 'Biblioman'

#### 2.5. Нова функция: `_filter_invalid_categories(categories, author_name=None)`

**Цел:** Филтриране на невалидни категории като авторски имена и generic термини.

**Филтрира:**
- Празни или твърде къси категории (< 3 символа)
- Generic термини: 'fiction', 'non-fiction', 'literature', 'general', 'juvenile', 'adult', 'young adult', 'large print'
- Авторски имена:
  - Категории, които съдържат части от името на автора
  - Категории с формат "име-име" (напр. "levine-paul")
  - Категории, подобни на името на автора

**Използване:**
- При обработка на CSV категории
- При сливане на Biblioman категории
- След сливането за филтриране на финалния списък

#### 2.6. Подобрена обработка на съществуващи книги

**Преди:**
- `BookAlreadyExistsError` се третираше като грешка
- Книгата не се добавяше към библиотеката
- Не се опитваше обогатяване

**Сега:**
- При `BookAlreadyExistsError`:
  1. Опит за обогатяване на съществуващата книга с Biblioman данни:
     - Обновяване на описание (ако е по-дълго)
     - Обновяване на корица (винаги приоритизира Biblioman)
     - Обновяване на издателство, дата, страници (ако липсват)
     - Сливане на категории
  2. Проверка дали книгата е в библиотеката на потребителя
  3. Ако не е → добавяне към библиотеката
  4. Третиране като "success" или "skipped" вместо "error"

### 3. Променен файл: `app/templates/settings/partials/data_import_books.html`

**Промяна:** Добавен е нов бутон/линк за "Импорт с Biblioman обогатяване"

```html
<a href="{{ url_for('import.import_biblioman_csv') }}" class="btn btn-info">
    <i class="bi bi-book me-1"></i> Импорт с Biblioman обогатяване
</a>
```

### 4. Променен файл: `app/simplified_book_service.py`

#### 4.1. Подобрен `build_book_data_from_row()`

**Промени:**
- Добавено мапиране на `cover_url` от CSV
- Добавена логика за филтриране на категории чрез `_filter_invalid_categories()`

#### 4.2. Нова функция: `_filter_invalid_categories(categories, author_name=None)`

**Идентична логика** като тази в `import_routes.py`, но като метод на `SimplifiedBookService`.

### 5. Променен файл: `app/services/metadata_providers/biblioman.py`

#### 5.1. Подобрена логика за генериране на URL на корицата

**Проблем:**
- `cover_field` понякога съдържа `book_id` вместо `chitanka_id`
- Hash частта е свързана с `book_id`, не с `chitanka_id`
- Това водеше до 404 грешки при опит за зареждане на корицата

**Решение:**
- Проверка дали `cover_field` започва с `book_id`
- Ако да → използва `book_id` за построяване на URL-а
- Ако не → използва `chitanka_id` (както преди)

**Пример:**
```
cover_field: "19475-652c0f8da4902.jpg"
book_id: 19475
chitanka_id: 1449

Преди: https://biblioman.chitanka.info/thumb/covers/1/4/4/9/1449-652c0f8da4902.1000.jpg (404)
Сега: https://biblioman.chitanka.info/thumb/covers/9/4/7/5/19475-652c0f8da4902.1000.jpg (работи)
```

## Конфигурация

### Environment Variables

```bash
MAX_BIBLIOMAN_IMPORT_ROWS=1000  # Максимален брой книги на импорт (по подразбиране: 1000)
```

## Използване

### Стъпка 1: Доступ до импорт страницата

1. Отидете в Settings → Data Import → Books
2. Кликнете на "Импорт с Biblioman обогатяване"

### Стъпка 2: Качване на CSV файл

1. Изберете CSV файл с данни за книги
2. Максимален размер: 100MB
3. Максимален брой книги: 1000 (конфигурируем)

### Стъпка 3: Автоматична обработка

Системата автоматично:
1. Разпознава колоните в CSV файла
2. Мапва ги към вътрешни полета
3. Обработва всяка книга:
   - Извлича данни от CSV
   - Търси в Biblioman DB
   - Обогатява с Biblioman данни
   - Добавя към библиотеката

### Стъпка 4: Проследяване на прогрес

- Страницата за прогрес показва:
  - Общ брой обработени книги
  - Успешно добавени
  - Грешки
  - Пропуснати (вече съществуващи)
  - Обогатени с Biblioman данни

## Поддържани CSV формати

### HandyLib формат

**Поддържани колони:**
- `Title` / `Заглавие` - Заглавие на книгата
- `Author` / `Автор` - Автор(и)
- `Publisher` / `Издателство` - Издателство
- `Published Date` / `Година` - Дата на публикуване
- `Format` - Формат (physical, ebook, audiobook)
- `Pages` / `Страници` - Брой страници
- `Series` / `Серия` - Серия
- `Volume` / `Том` - Том в серията
- `Language` / `Език` - Език
- `ISBN` / `ISBN13` / `ISBN10` - ISBN номера
- `Summary` - Описание/Резюме
- `Image Url` - URL на корицата
- `Genres` / `Категории` - Категории/Жанрове
- `Location` - Местоположение

### Автоматично разпознаване

Системата автоматично разпознава колоните дори ако:
- Имената са на български език
- Има малки разлики в имената
- Има допълнителни интервали или специални символи

## Приоритети на данните

### Приоритет 1: Biblioman DB
- Заглавие
- Автори (български приоритет)
- Описание
- Корица
- ISBN
- Издателство (ако има кирилица)
- Дата на публикуване
- Брой страници
- Категории

### Приоритет 2: CSV данни
- Използват се само ако Biblioman няма дадено поле
- Или ако Biblioman данните не са по-добри

## Обработка на грешки

### Съществуващи книги

**Преди:**
- Третирани като грешки
- Не се добавяха към библиотеката
- Не се обогатяваха

**Сега:**
- Третирани като "success" или "skipped"
- Опит за обогатяване с Biblioman данни
- Добавяне към библиотеката (ако не е там)

### Липсващи Biblioman данни

- Книгата се импортира с CSV данните
- Не се третира като грешка
- Логва се предупреждение

### Невалидни категории

- Автоматично филтриране
- Премахване на авторски имена
- Премахване на generic термини

## Логиране

### Debug ниво

- Детайлна информация за всяка обработена книга
- Информация за обогатяване
- Информация за сливане на данни

### Info ниво

- Успешни импорти
- Обогатени книги
- Статистики

### Warning ниво

- Липсващи Biblioman данни
- Грешки при обогатяване
- Грешки при добавяне към библиотеката

## Технически детайли

### Асинхронна обработка

- Използва `asyncio` и `run_async` за неблокираща обработка
- Прогресът се актуализира редовно
- Потребителят може да напусне страницата без да спира импорта

### База данни

- Използва KuzuDB за съхранение на книгите
- Използва MariaDB за Biblioman DB заявки
- Thread-safe операции чрез SafeKuzuManager

### Временни файлове

- CSV файловете се съхраняват временно
- Автоматично изтриване след обработка
- Използва `tempfile` за безопасно съхранение

## Бъдещи подобрения

1. **Поддръжка на по-големи импорти:**
   - Batch обработка
   - Паралелна обработка на множество книги

2. **По-добро обогатяване:**
   - Опит за множество източници
   - По-интелигентно сливане на данни

3. **По-добра обработка на грешки:**
   - Retry логика
   - По-детайлни съобщения за грешки

4. **Експорт на резултати:**
   - CSV с резултатите от импорта
   - Статистики и отчети

## Заключение

Тази функционалност предоставя мощен и гъвкав начин за импорт на книги с автоматично обогатяване от Biblioman DB. Тя е оптимизирана за български книги и предоставя по-добро качество на данните чрез приоритизиране на Biblioman като основен източник на метаданни.

